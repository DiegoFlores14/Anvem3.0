<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - {{ artist_name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
  <link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
/>

</head>
<body>
 <header class="header">
  <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Logo">
  <h1 class="header-title">{{ artist_name }}</h1>
  <div class="header-right">
    <!-- Men√∫ de tres puntos -->
   <div class="dropdown">
  <button class="btn dropdown-toggle menu-btn" type="button" id="menuButton"
    data-bs-toggle="dropdown" aria-expanded="false">
    ‚ãÆ
  </button>
  <ul class="dropdown-menu dropdown-menu-end custom-dropdown" aria-labelledby="menuButton">
    <li>
      <a class="dropdown-item custom-item" href="{{ url_for('logout') }}">Cerrar sesi√≥n</a>
    </li>
  </ul>
</div>

</header>


 
  <div class="main-container">
  <div class="row-quarter-info">
    <form method="GET" action="{{ url_for('dashboard') }}" class="quarter-select">

      {# Si es admin, mostrar selector de artista #}
      {% if available_artists %}
        <select name="artist" class="form-select form-select-sm" onchange="this.form.submit()" style="min-width: 120px;">
          {% for key in available_artists %}
            <option value="{{ key }}" {% if key == selected_artist_key %}selected{% endif %}>
              {% if key == 'all' %}
                Resumen General
              {% else %}
                {{ USERS[key].name if USERS[key] is defined and USERS[key].name else key }}
              {% endif %}
            </option>
          {% endfor %}
        </select>
      {% endif %}

      {# Selector de a√±o #}
      <select name="year" class="form-select form-select-sm" onchange="this.form.submit()" style="min-width: 100px;">
        {% for y in available_years %}
          <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>

      {# Selector de trimestre #}
      <select name="quarter" class="form-select form-select-sm" onchange="this.form.submit()">
        {% for q in available_quarters %}
          <option value="{{ q }}" {% if selected_quarter == q %}selected{% endif %}>M{{ q }}</option>
        {% endfor %}
      </select>
    </form>

    <div class="quarter-label-box">
      <div class="quarter-label">{{ selected_year }}</div>
      <div class="quarter-dates" id="quarter-dates">Cargando fechas...</div>
    </div>

    <a href="{{ url_for('download_statement', quarter=selected_quarter, year=selected_year) }}" class="btn btn-outline-dark btn-sm">DOWNLOAD STATEMENT</a>
  </div>

  {# Secci√≥n de resumen solo para AdminUser #}
  {% if selected_artist_key == 'AdminUser' %}
    <div class="bottom-box mt-4">
      <div class="bottom-box-header">Resumen por Artista</div>
      <div id="summary-table">
        <!-- JS lo llenar√° din√°micamente -->
      </div>
      <div class="text-end mt-2">
        <strong>Total General:</strong> <span id="summary-total">-</span> USD
      </div>
    </div>
  {% endif %}


      

<div class="row-upper">
  <!-- Imagen del artista: primero en m√≥vil, segundo en escritorio -->
  <div class="center-box order-1 order-md-2">
    <div class="center-box-header">{{ artist_name }}</div>
    <div class="center-box-body">
      <img src="{{ url_for('static', filename=artist_image) }}" alt="Artista">
    </div>
  </div>

  <!-- Estad√≠sticas: segundo en m√≥vil, primero en escritorio -->
   <div class="left-col order-2 order-md-1">
    
    <div class="stat-box">
      <div class="stat-box-header">Royalties M{{ selected_quarter }}</div>
      <div class="stat-box-body" id="royalties-value">Cargando...</div>
    </div>
    
    <div class="stat-box">
      <div class="stat-box-header">Total Earned {{ selected_year }}</div>
      <div class="stat-box-body" id="total-earned-value">Cargando...</div>
    </div>
  </div>

  <!-- Stay Connected: √∫ltimo en m√≥vil y en escritorio -->
  <div class="right-duda order-3 order-md-3">
    <div class="network-top">
    </div><!-- ====================== ROYALTIES BREAKDOWN ====================== -->
<!-- ====================== ROYALTIES BREAKDOWN ====================== -->
<div class="royalties-flow">
  <h2>Royalties Breakdown</h2>

  <div class="royalty-step">
    <div class="icon">üí∞</div>
    <div class="content">
      <span class="label">Gross Amount</span>
      <span class="value" id="gross-amount">$0.00</span>
    </div>
  </div>
  <div class="connector-line"></div>

  <div class="royalty-step">
    <div class="icon">üìâ</div>
    <div class="content">
      <span class="label">Distribution Fee (20%)</span>
      <span class="value" id="distribution-fee">$0.00</span>
    </div>
  </div>
  <div class="connector-line"></div>

  <div class="royalty-step">
    <div class="icon">üè¶</div>
    <div class="content">
      <span class="label">Net After Fee</span>
      <span class="value" id="net-after-fee">$0.00</span>
    </div>
  </div>
  <div class="connector-line"></div>

  <div class="royalty-step">
    <div class="icon">ü§ù</div>
    <div class="content">
      <span class="label">ANVEM Share (50%)</span>
      <span class="value" id="anvem-share">$0.00</span>
    </div>
  </div>
  <div class="connector-line"></div>

  <div class="royalty-step final">
    <div class="icon">üé§</div>
    <div class="content">
      <span class="label">Artist Share (50%)</span>
      <span class="value" id="artist-share">$0.00</span>
    </div>
  </div>
</div>
  </div>
</div>

<div class="row-bottom">
  <div class="bottom-box">
    <div class="bottom-box-header">Top Songs</div>
    <div id="song-table" class="fade show">
      <!-- Aqu√≠ JS rellenar√° din√°micamente -->
    </div>
    <div id="song-chart" class="song-chart fade" style="display: none;">
      <img src="{{ url_for('static', filename='generated/song_bar_chart.png') }}" alt="Bar Chart">
    </div>
    <button class="toggle-btn" onclick="toggleSongView()">show as source</button>
  </div>

  <div class="bottom-box">
    <div class="bottom-box-header">Top Source</div>
    <div id="source-table" class="fade show">
      <!-- Aqu√≠ JS rellenar√° din√°micamente -->
    </div>
    <div id="source-chart" class="source-chart fade" style="display: none;">
      <img src="{{ url_for('static', filename='generated/source_pie_chart.png') }}" alt="Pie Chart">
    </div>
    <button class="toggle-btn" onclick="toggleSourceView()">show as source</button>
  </div>
</div>

<div class="card mt-4">
  <div class="card-header text-white bg-dark">
    Balance General
  </div>
  <div class="card-body">
    <table class="table table-borderless mb-0 text-center align-middle">
      <tbody>
        <tr>
          <td><strong>Ganancias Generadas</strong></td>
          <td id="ganancia">-</td>
        </tr>
        <tr>
          <td><strong>Inversi√≥n</strong></td>
          <td id="inversion" class="text-break">-</td>
        </tr>
        <tr>
          <td><strong>Balance</strong></td>
          <td id="balance" class="fw-bold">-</td>
        </tr>
      </tbody>
    </table>

    <!-- Gr√°fico de barras para balance general -->
    <div class="text-center mt-4">
      <img src="{{ url_for('static', filename='generated/balance_bar_chart.png') }}" 
           alt="Gr√°fico Balance General" 
           class="img-fluid" 
           style="max-width: 400px;">
    </div>
  </div>
</div>




  </div>

  <footer class="text-center py-3">
    <small class="text-muted">¬© 2025 Anvem Music. Todos los derechos reservados.</small>
  </footer>

  <script>
    function toggleSourceView() {
      const table = document.getElementById('source-table');
      const chart = document.getElementById('source-chart');
      if (table.classList.contains('show')) {
        table.classList.remove('show');
        setTimeout(() => {
          table.style.display = 'none';
          chart.style.display = 'block';
          requestAnimationFrame(() => chart.classList.add('show'));
        }, 400);
      } else {
        chart.classList.remove('show');
        setTimeout(() => {
          chart.style.display = 'none';
          table.style.display = 'block';
          requestAnimationFrame(() => table.classList.add('show'));
        }, 400);
      }
    }

    function toggleSongView() {
      const table = document.getElementById('song-table');
      const chart = document.getElementById('song-chart');
      if (table.classList.contains('show')) {
        table.classList.remove('show');
        setTimeout(() => {
          table.style.display = 'none';
          chart.style.display = 'block';
          requestAnimationFrame(() => chart.classList.add('show'));
        }, 400);
      } else {
        chart.classList.remove('show');
        setTimeout(() => {
          chart.style.display = 'none';
          table.style.display = 'block';
          requestAnimationFrame(() => table.classList.add('show'));
        }, 400);
      }
    }
  </script>
  <script>
    document.addEventListener("DOMContentLoaded", loadDashboardData);
  
 function loadDashboardData() {
  const year = "{{ selected_year }}";
  const quarter = "{{ selected_quarter }}";
  const artist = "{{ selected_artist_key }}";

  fetch(`/load_dashboard_data?year=${year}&quarter=${quarter}&artist=${artist}`)
  .then(response => response.json())
  .then(data => {
    // Ganancia generada
    document.getElementById("ganancia").textContent = data.future_total.toFixed(2) + " USD";

    // Inversi√≥n y Balance
    const inversionElem = document.getElementById("inversion");
    const balanceElem = document.getElementById("balance");

    if ("summary_table" in data) {
      const resumenEl = document.getElementById("summary-table");
      const totalEl = document.getElementById("summary-total");
      resumenEl.innerHTML = data.summary_table;
      totalEl.textContent = data.summary_total.toFixed(2);
    }

    if (typeof data.investment === "string") {
      inversionElem.textContent = data.investment;
      balanceElem.textContent = "N/A";
      balanceElem.style.color = "gray";
    } else {
      inversionElem.textContent = data.investment.toFixed(2) + " USD";
      balanceElem.textContent = data.balance.toFixed(2) + " USD";
      balanceElem.style.color = data.balance >= 0 ? "green" : "red";
    }

    // Royalties
    const royaltiesEl = document.getElementById("royalties-value");
    royaltiesEl.textContent = `$${parseFloat(data.sheets.total_royalties).toFixed(2)}`;

    // Total Earned
    const totalEl = document.getElementById("total-earned-value");
    totalEl.textContent = `$${parseFloat(data.future_total).toFixed(2)}`;

    // Quarter Dates
    const qd = document.getElementById("quarter-dates");
    qd.textContent = data.quarter_dates;

    // Tabla por canci√≥n
    const songTable = document.getElementById("song-table");
    songTable.innerHTML = data.sheets.by_song;

    // Tabla por fuente
    const sourceTable = document.getElementById("source-table");
    sourceTable.innerHTML = data.sheets.by_source;

    // ========================= ROYALTIES BREAKDOWN =========================
    if (data.breakdown) {
      document.getElementById("gross-amount").textContent = `$${data.breakdown.gross_amount.toFixed(2)}`;
      document.getElementById("distribution-fee").textContent = `-$${data.breakdown.distribution_fee.toFixed(2)}`;
      document.getElementById("net-after-fee").textContent = `$${data.breakdown.net_after_fee.toFixed(2)}`;
      document.getElementById("anvem-share").textContent = `-$${data.breakdown.anvem_share.toFixed(2)}`;
      document.getElementById("artist-share").textContent = `$${data.breakdown.artist_share.toFixed(2)}`;
    }
  })
  .catch(err => {
    console.error("Error cargando datos:", err);
    alert("Error al cargar el dashboard. Intenta m√°s tarde.");
  });

}




  </script>
  <!-- Bootstrap JS (incluye Popper) - REQUIRED para dropdowns -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Burbujas flotantes de redes sociales -->
<div class="floating-bubbles">
  <a href="https://www.instagram.com/anvemmusic/" target="_blank" class="bubble insta" title="Instagram">
    <i class="fab fa-instagram"></i>
  </a>
  <a href="https://www.tiktok.com/@anvemclothing" target="_blank" class="bubble tiktok" title="TikTok">
    <i class="fab fa-tiktok"></i>
  </a>
  <a href="https://www.youtube.com/@AnvemMusic" target="_blank" class="bubble youtube" title="YouTube">
    <i class="fab fa-youtube"></i>
  </a>
</div>
<!-- Burbuja de dudas / aclaraciones -->
<div id="help-bubble" class="help-bubble" title="¬øAlguna duda o aclaraci√≥n?">
  üí¨
</div>

<!-- Ventana emergente del chat -->
<div id="help-chat" class="help-chat">
  <div class="help-chat-header">
    <span id="help-greeting"></span>
    <button id="help-close">&times;</button>
  </div>
  <div class="help-chat-body">
    <label for="help-message">Asunto:</label>
    <textarea id="help-message" placeholder="Escribe aqu√≠ tu duda o aclaraci√≥n..."></textarea>
  </div>
  <div class="help-chat-footer">
    <button id="help-send">Enviar</button>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const helpBubble = document.getElementById('help-bubble');
  const helpChat = document.getElementById('help-chat');
  const helpClose = document.getElementById('help-close');
  const helpSend = document.getElementById('help-send');
  const greeting = document.getElementById('help-greeting');
  const messageBox = document.getElementById('help-message');

  // Cambia esta variable por la del artista en sesi√≥n:
  const artistName = "{{ artist_name }}";  // desde Flask, por ejemplo

  greeting.textContent = `üëã Hola ${artistName}, cu√©ntanos tu duda o aclaraci√≥n.`;

  helpBubble.addEventListener('click', () => {
    helpChat.style.display = 'flex';
  });

  helpClose.addEventListener('click', () => {
    helpChat.style.display = 'none';
  });

  helpSend.addEventListener('click', async () => {
    const message = messageBox.value.trim();
    if (!message) {
      alert('Por favor escribe un asunto antes de enviar.');
      return;
    }

    const response = await fetch('/send_help_message', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ artist: artistName, message })
    });

    if (response.ok) {
      alert('Tu mensaje ha sido enviado. ¬°Gracias!');
      messageBox.value = '';
      helpChat.style.display = 'none';
    } else {
      alert('Hubo un error al enviar tu mensaje. Intenta de nuevo.');
    }
  });
});
</script>


</body>
</html>
